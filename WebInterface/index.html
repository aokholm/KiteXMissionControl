<!DOCTYPE HTML>
<html>
  <head>
    <script type="text/javascript">
      var ws

      var controlAmplitude = 300 // +- 300 mm from
      var controlOffSet = 0
      var controlInput = 0
      var lastMove = 0;

      var buffer = new Int16Array(1)


      function connect() {
        // Let us open a web socket
        ws = new WebSocket("ws://localhost:8080") // port 82 for control
        ws.binaryType = "arraybuffer"

        ws.onopen = function() {
          // Web Socket is connected, send data using send()
          document.getElementById("connectedBox").checked = true
          ws.send("id,WEBCONTROL")
        }

        ws.onmessage = function (msg) {
          if(msg.data instanceof ArrayBuffer) {
            var data = new Float64Array(msg.data)
            var time = data[0]
            var posx = data[1]
            var posy = data[2]
            // var posz = data[3]
            // var velx = data[4]
            // var velx = data[5]
            // var velx = data[6]
            // var angularVelocity = data[7]

            document.getElementById("time").innerHTML = time;
            document.getElementById("posx").innerHTML = posx;
            document.getElementById("posy").innerHTML = posy;
            // document.getElementById("posz").innerHTML = posz;

            // console.log(time)

          } else {
            processText(msg.data)
          }

          var received_msg = msg.data
        }

        ws.onclose = function() {
          // websocket is closed.
          document.getElementById("connectedBox").checked = false
        }
      }

      function newControlSliderValue(val) {
        // do nothing if last move was less than 25 ms ago
        if(Date.now() - lastMove > 25) {

          controlInput = (val/500-1) * 2 * 200 * 36 / (40*20)  * controlAmplitude  // 400 steps pr 40 mm
          buffer[0] = controlInput // + controlOffSet
          console.log(buffer[0])
          ws.send( buffer )

          lastMove = Date.now();
        }
      }

      function zero() {
        //controlOffSet += controlInput
        ws.send('motor,zero')
        document.getElementById("sliderControl").value = 500
      }


      function processText(data) {
        var input = data.split(',')
        command = input[0]
        value = input[1]
        switch (command) {
          case 'state':
            console.log(data)
            switch (value) {
              case 'start':
                document.getElementById("loggingBox").checked = true
                break;
              case 'stop':
                document.getElementById("loggingBox").checked = false
                break;
              default:
            }
          break
          case 'motor':
            console.log(data)
            switch (value) {
              case 'on':
                document.getElementById("motorPowerBox").checked = true
                break;
              case 'off':
                document.getElementById("motorPowerBox").checked = false
                break;
              // case 'online':
              //   document.getElementById("motorConnected").checked = true
              //   break;
              // case 'offline':
              //   document.getElementById("motorConnected").checked = false
              //   break;
              default:

            }
          break
          case 'bat1':
            document.getElementById("bat1").innerHTML = parseFloat(value).toFixed(2)
          break
          case 'phoneBat':
            document.getElementById("phoneBat").innerHTML = (100*parseFloat(value)).toFixed(2)
          break
          case 'camera':
            console.log(data)
            switch (value) {
              case 'on':
                document.getElementById("cameraTrackingBox").checked = true
                break;
              case 'off':
                document.getElementById("cameraTrackingBox").checked = false
                break;
            }
          break

          default:
            console.log(data)
        }
      }

      connect()

      // var pos = 200
      // setInterval(function () {
      //   console.log("yeha")
      //   pos = -pos
      //   newControlSliderValue(500 + pos)
      // }, 1000)

    </script>
  </head>
  <body>

      <label><input type="checkbox" id="connectedBox" value="first_checkbox"> Connected</label> <a href="javascript:connect()">reconnect</a> <br>
      <label><input type="checkbox" id="loggingBox" value="second_checkbox"> Logging</label> <br>
      <!-- <label><input type="checkbox" id="motorConnected"> Motor Conencted</label> <br> -->
      <label><input type="checkbox" id="motorPowerBox"> Motor Power</label> <br>
      <label><input type="checkbox" id="cameraTrackingBox"> Camera Tracking</label> <br>

      <label>Main Battery Voltage: </label><label id="bat1"></label><br>
      <label>Phone Battery Percentage: </label><label id="phoneBat"></label>


      <p>Control</p>
      <input id="sliderControl" type="range" min="0" max="1000" step="1" oninput="newControlSliderValue(this.value)" style="width:400px"/>
      <br>
      <button type="button" onclick="zero()">Zero</button>
      <br>
      <button type="button" onclick="ws.send('state,start')">Logging Start</button>
      <button type="button" onclick="ws.send('state,stop')">Logging Stop</button>
      <br>
      <button type="button" onclick="ws.send('motor,on')">Motor Power On</button>
      <button type="button" onclick="ws.send('motor,off')">Motor Power Off</button>
      <br>
      <button type="button" onclick="ws.send('camera,on')">Camera Tracking On</button>
      <button type="button" onclick="ws.send('camera,off')">Camera Tracking Off</button>

      <p>Amplitude</p>
      <input id="sliderAmplitude" type="range" min="0" max="600" step="1" oninput="controlAmplitude=this.value" style="width:400px"/>

      <p id="time"></p>
      <p id="posx"></p>
      <p id="posy"></p>
      <p id="posz"></p>
      <p id="velx"></p>
      <p id="vely"></p>
      <p id="velz"></p>
      <p id="angVel"></p>
  </body>
</html>
